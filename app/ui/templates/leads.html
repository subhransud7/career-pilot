{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3>Leads</h3>
  <form class="d-flex gap-2" method="get" action="/leads">
    <select class="form-select" name="state">
      <option value="" {% if not state %}selected{% endif %}>All</option>
      {% for s in ["IN_REVIEW","APPROVED","REJECTED","MAILED","MAIL_FAILED","WAITING_RESPONSE","RESPONDED","ARCHIVED"] %}
      <option value="{{ s }}" {% if state == s %}selected{% endif %}>{{ s }}</option>
      {% endfor %}
    </select>
    <button class="btn btn-outline-secondary">Filter</button>
  </form>
</div>

<form hx-post="/leads/bulk-send" hx-target="#bulk-status" hx-swap="innerHTML" class="mb-3">
  <button class="btn btn-success">Bulk Send (APPROVED)</button>
</form>
<div id="bulk-status" class="mb-3"></div>

<button class="btn btn-danger mb-2" onclick="toggleBulkMode()">
  Bulk Delete
</button>

<form id="bulk-delete-form"
      method="post"
      action="/leads/bulk-delete"
      style="display:none;">
  <button class="btn btn-danger mb-2">
    Confirm Delete
  </button>
</form>

<div class="d-flex justify-content-end mb-2 gap-2">
  {% if page > 1 %}
  <a class="btn btn-outline-secondary btn-sm"
     href="/leads?page={{ page - 1 }}{% if state %}&state={{ state }}{% endif %}">
     Prev
  </a>
  {% endif %}

  <span class="align-self-center">
    Page {{ page }} of {{ total_pages }}
  </span>

  {% if page < total_pages %}
  <a class="btn btn-outline-secondary btn-sm"
     href="/leads?page={{ page + 1 }}{% if state %}&state={{ state }}{% endif %}">
     Next
  </a>
  {% endif %}
</div>

<table class="table table-hover">
  <thead>
    <tr>
      <th id="bulk-column" style="display:none;">Select</th>
      <th>Company</th>
      <th>Role</th>
      <th>Email</th>
      <th>Post Link</th>
      <th>Date Posted</th>
      <th>Score</th>
      <th>Status</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
  {% for lead in leads %}
    <tr>
      <td class="bulk-checkbox" style="display:none;">
        <input type="checkbox" name="lead_ids" value="{{ lead.id }}" form="bulk-delete-form">
      </td>
      <td>{{ lead.company or '-' }}</td>
      <td>
        <a href="#"
           hx-get="/leads/{{ lead.id }}"
           hx-target="closest tr"
           hx-swap="afterend"
           hx-on="click: closeExistingDetail()">
           {{ lead.role or '-' }}
        </a>
      </td>
      <td>{{ lead.email or '-' }}</td>
      <td><a href="{{ lead.post_link }}" target="_blank">Open</a></td>
      <td>{{ lead.date_posted or '-' }}</td>
      <td><span class="badge bg-{{ score_class(lead.score) }}">{{ lead.score or 0 }}</span></td>
      <td><span class="badge bg-secondary">{{ lead.state }}</span></td>
      <td class="d-flex gap-1">
        <form hx-post="/leads/{{ lead.id }}/state" hx-target="#detail-status" hx-swap="innerHTML">
          <input type="hidden" name="next_state" value="APPROVED" />
          <button class="btn btn-sm btn-outline-success">Approve</button>
        </form>
        <form hx-post="/leads/{{ lead.id }}/state" hx-target="#detail-status" hx-swap="innerHTML">
          <input type="hidden" name="next_state" value="REJECTED" />
          <button class="btn btn-sm btn-outline-danger">Reject</button>
        </form>
        <form hx-post="/leads/{{ lead.id }}/state"
              hx-target="#detail-status"
              hx-swap="innerHTML">
          <input type="hidden" name="next_state" value="MAILED" />
          <button class="btn btn-sm btn-outline-primary">
            Mark Mailed
          </button>
        </form>
        <form hx-post="/leads/{{ lead.id }}/delete"
              hx-target="closest tr"
              hx-swap="outerHTML">
          <button class="btn btn-sm btn-outline-danger">ðŸ—‘</button>
        </form>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>
<div id="detail-status"></div>
<script>
function closeExistingDetail() {
  const existing = document.querySelector(".lead-detail-row");
  if (existing) {
    existing.remove();
  }
}

function toggleBulkMode() {
  const checkboxes = document.querySelectorAll(".bulk-checkbox");
  const header = document.getElementById("bulk-column");
  const form = document.getElementById("bulk-delete-form");

  checkboxes.forEach(cb => {
    cb.style.display = cb.style.display === "none" ? "table-cell" : "none";
  });

  header.style.display = header.style.display === "none" ? "table-cell" : "none";
  form.style.display = form.style.display === "none" ? "block" : "none";
}
</script>
{% endblock %}
